[% PROCESS settings/header.html %]

<h2>MellowDSP Player Settings</h2>

<script>
function uploadFIR(channel) {
    var fileInput = document.getElementById('fir_' + channel + '_file');
    var file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file');
        return;
    }
    
    var formData = new FormData();
    formData.append('file', file);
    formData.append('channel', channel);
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/plugins/MellowDSP/upload', true);
    
    xhr.onload = function() {
        if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            if (response.success) {
                document.getElementById('pref_fir_' + channel).value = response.path;
                alert('File uploaded and processed successfully');
            } else {
                alert('Upload error: ' + (response.error || 'Unknown error'));
            }
        } else {
            alert('Upload failed');
        }
    };
    
    xhr.send(formData);
}
</script>

[% WRAPPER setting title="Enable MellowDSP" desc="Enable audio processing for this player" %]
    <input name="pref_player_enabled" type="checkbox" [% IF prefs.player_enabled %] checked [% END %]>
[% END %]

<hr>

[% WRAPPER setting title="Input Formats" desc="Audio formats to process" %]
    <input name="pref_input_aiff" type="checkbox" [% IF prefs.input_aiff %] checked [% END %]>
    <label>AIFF</label>&nbsp;&nbsp;
    
    <input name="pref_input_alac" type="checkbox" [% IF prefs.input_alac %] checked [% END %]>
    <label>Apple Lossless</label>&nbsp;&nbsp;
    
    <input name="pref_input_flac" type="checkbox" [% IF prefs.input_flac %] checked [% END %]>
    <label>FLAC</label>&nbsp;&nbsp;
    
    <input name="pref_input_wav" type="checkbox" [% IF prefs.input_wav %] checked [% END %]>
    <label>WAV</label>
[% END %]

[% WRAPPER setting title="Target Sample Rate" desc="Upsampling target frequency" %]
    <select name="pref_target_rate">
        <option value="44100" [% IF prefs.target_rate == '44100' %]selected[% END %]>44.1 kHz</option>
        <option value="88200" [% IF prefs.target_rate == '88200' %]selected[% END %]>88.2 kHz</option>
        <option value="176400" [% IF prefs.target_rate == '176400' %]selected[% END %]>176.4 kHz</option>
        <option value="352800" [% IF prefs.target_rate == '352800' %]selected[% END %]>352.8 kHz</option>
        <option value="705600" [% IF prefs.target_rate == '705600' %]selected[% END %]>705.6 kHz</option>
        <option value="768000" [% IF prefs.target_rate == '768000' %]selected[% END %]>768 kHz</option>
    </select>
[% END %]

[% WRAPPER setting title="Phase Response" desc="Resampling phase characteristics" %]
    <select name="pref_phase_response">
        <option value="linear" [% IF prefs.phase_response == 'linear' %]selected[% END %]>Linear Phase</option>
        <option value="intermediate" [% IF prefs.phase_response == 'intermediate' %]selected[% END %]>Intermediate Phase</option>
        <option value="minimum" [% IF prefs.phase_response == 'minimum' %]selected[% END %]>Minimum Phase</option>
    </select>
[% END %]

[% WRAPPER setting title="Output Bit Depth" desc="Target bit depth" %]
    <select name="pref_output_depth">
        <option value="16" [% IF prefs.output_depth == '16' %]selected[% END %]>16-bit</option>
        <option value="24" [% IF prefs.output_depth == '24' %]selected[% END %]>24-bit</option>
        <option value="32" [% IF prefs.output_depth == '32' %]selected[% END %]>32-bit</option>
    </select>
[% END %]

[% WRAPPER setting title="Dithering Type" desc="Dithering algorithm" %]
    <select name="pref_dither_type">
        <option value="none" [% IF prefs.dither_type == 'none' %]selected[% END %]>None</option>
        <option value="triangular" [% IF prefs.dither_type == 'triangular' %]selected[% END %]>Triangular</option>
        <option value="shaped" [% IF prefs.dither_type == 'shaped' %]selected[% END %]>Shaped</option>
        <option value="lipshitz" [% IF prefs.dither_type == 'lipshitz' %]selected[% END %]>Lipshitz</option>
        <option value="fweighted" [% IF prefs.dither_type == 'fweighted' %]selected[% END %]>F-weighted</option>
        <option value="eweighted" [% IF prefs.dither_type == 'eweighted' %]selected[% END %]>E-weighted</option>
    </select>
[% END %]

[% WRAPPER setting title="Dither Precision" desc="Target precision" %]
    <select name="pref_dither_precision">
        <option value="16" [% IF prefs.dither_precision == '16' %]selected[% END %]>16-bit</option>
        <option value="18" [% IF prefs.dither_precision == '18' %]selected[% END %]>18-bit</option>
        <option value="20" [% IF prefs.dither_precision == '20' %]selected[% END %]>20-bit</option>
        <option value="22" [% IF prefs.dither_precision == '22' %]selected[% END %]>22-bit</option>
        <option value="24" [% IF prefs.dither_precision == '24' %]selected[% END %]>24-bit</option>
    </select>
[% END %]

<hr>

[% WRAPPER setting title="FIR Filters" desc="Room correction from REW" %]
    <input name="pref_fir_enabled" type="checkbox" [% IF prefs.fir_enabled %] checked [% END %]>
    <label>Enable FIR Filtering</label>
[% END %]

[% WRAPPER setting title="Left Channel FIR Filter" desc="Upload WAV file from REW" %]
    <input type="file" id="fir_left_file" accept=".wav" style="display:none;">
    <input type="text" name="pref_fir_left" id="pref_fir_left" value="[% prefs.fir_left %]" size="50" readonly>
    <button type="button" onclick="document.getElementById('fir_left_file').click();">Select File</button>
    <button type="button" onclick="uploadFIR('left');">Upload & Process</button>
    <br><small>File will be uploaded to server and automatically converted to target sample rate</small>
[% END %]

[% WRAPPER setting title="Right Channel FIR Filter" desc="Upload WAV file from REW" %]
    <input type="file" id="fir_right_file" accept=".wav" style="display:none;">
    <input type="text" name="pref_fir_right" id="pref_fir_right" value="[% prefs.fir_right %]" size="50" readonly>
    <button type="button" onclick="document.getElementById('fir_right_file').click();">Select File</button>
    <button type="button" onclick="uploadFIR('right');">Upload & Process</button>
    <br><small>File will be uploaded to server and automatically converted to target sample rate</small>
[% END %]

[% PROCESS settings/footer.html %]
